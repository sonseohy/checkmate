image: docker:latest

stages:
  - build
  - deploy

variables:
  DOCKER_IMAGE: checkmate-be

before_script:
  - echo "ğŸš€ ë°±ì—”ë“œ GitLab CI ì‹œì‘"
  - docker --version

build_checkmate_be:
  stage: build
  only:
    - be
  script:
    - cd checkmate-be
    # âœ… application-secret.yml ìƒì„±
    - echo "$APPLICATION_SECRET_YML" > src/main/resources/application-secret.yml
    - echo "âœ… application-secret.yml íŒŒì¼ ìƒì„± ì™„ë£Œ"
    # âœ… .env íŒŒì¼ ìƒì„±
    - cd ..
    - echo "$BACKEND_ENV" > .env
    - echo "âœ… .env íŒŒì¼ ìƒì„± ì™„ë£Œ"

    # âœ… Docker ì´ë¯¸ì§€ ì •ë¦¬ ë° ë¹Œë“œ
    - docker stop $DOCKER_IMAGE || true
    - docker rm $DOCKER_IMAGE || true
    - docker rmi $DOCKER_IMAGE || true
    - docker build -t $DOCKER_IMAGE checkmate-be
  artifacts:
    paths:
      - .env
      - checkmate-be/build/libs/
  after_script:
    - |
      if [ "$CI_JOB_STATUS" == "success" ]; then
        curl -X POST -H 'Content-Type: application/json' \
        -d "{\"text\": \"âœ… [ë°±ì—”ë“œ ë¹Œë“œ ì„±ê³µ] $CI_PROJECT_NAME - $CI_COMMIT_BRANCH\"}" $MATTERMOST_WEBHOOK
      else
        curl -X POST -H 'Content-Type: application/json' \
        -d "{\"text\": \"âŒ [ë°±ì—”ë“œ ë¹Œë“œ ì‹¤íŒ¨] $CI_PROJECT_NAME - $CI_COMMIT_BRANCH\"}" $MATTERMOST_WEBHOOK
      fi

deploy_checkmate_be:
  stage: deploy
  only:
    - be
  script:
    - docker stop $DOCKER_IMAGE || true
    - docker rm $DOCKER_IMAGE || true
    - docker run -d --name $DOCKER_IMAGE -p 8080:8080 --env-file .env $DOCKER_IMAGE

after_script:
  - |
    if [ "$CI_JOB_STATUS" == "success" ]; then
      curl -X POST -H 'Content-Type: application/json' \
      -d "{\"text\": \"âœ… [ë°±ì—”ë“œ ë°°í¬ ì„±ê³µ] $CI_PROJECT_NAME - $CI_COMMIT_BRANCH\"}" $MATTERMOST_WEBHOOK
    else
      curl -X POST -H 'Content-Type: application/json' \
      -d "{\"text\": \"âŒ [ë°±ì—”ë“œ ë°°í¬ ì‹¤íŒ¨] $CI_PROJECT_NAME - $CI_COMMIT_BRANCH\"}" $MATTERMOST_WEBHOOK
    fi

