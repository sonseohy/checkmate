image: node:22.12.0

stages:
  - build
  - deploy

variables:
  MATTERMOST_WEBHOOK: $MATTERMOST_WEBHOOK  # GitLab > CI/CD > Variables ì— ì„¤ì •í•œ webhook URL

before_script:
  - echo "GitLab CI/CD ì‹œì‘!"
  - node -v
  - npm -v

build_checkmate_fe:
  stage: build
  only:
    - fe
  script:
    - cd checkmate-fe
    - docker build --build-arg FRONTEND_ENV="$FRONTEND_ENV" -t checkmate-fe .
  after_script:
    - |
      if [ "$CI_JOB_STATUS" == "success" ]; then
        curl -X POST -H 'Content-Type: application/json' \
        -d "{\"text\": \"âœ… [í”„ë¡ íŠ¸ ë¹Œë“œ ì„±ê³µ] $CI_PROJECT_NAME - $CI_COMMIT_BRANCH\"}" $MATTERMOST_WEBHOOK
      else
        curl -X POST -H 'Content-Type: application/json' \
        -d "{\"text\": \"âŒ [í”„ë¡ íŠ¸ ë¹Œë“œ ì‹¤íŒ¨] $CI_PROJECT_NAME - $CI_COMMIT_BRANCH\"}" $MATTERMOST_WEBHOOK
      fi

deploy_checkmate_fe:
  stage: deploy
  only:
    - fe
  script:
    - echo "ğŸš€ Docker ë°°í¬ ì‹œì‘"
    - docker stop checkmate-fe-container || true
    - docker rm checkmate-fe-container || true
    - docker rmi checkmate-fe || true
    - docker run -d --name checkmate-fe-container -p 3000:80 checkmate-fe
  after_script:
    - |
      if [ "$CI_JOB_STATUS" == "success" ]; then
        curl -X POST -H 'Content-Type: application/json' \
        -d "{\"text\": \"âœ… [í”„ë¡ íŠ¸ ë°°í¬ ì„±ê³µ] $CI_PROJECT_NAME - $CI_COMMIT_BRANCH\"}" $MATTERMOST_WEBHOOK
      else
        curl -X POST -H 'Content-Type: application/json' \
        -d "{\"text\": \"âŒ [í”„ë¡ íŠ¸ ë°°í¬ ì‹¤íŒ¨] $CI_PROJECT_NAME - $CI_COMMIT_BRANCH\"}" $MATTERMOST_WEBHOOK
      fi

